name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Extract version from tag
      id: extract_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Build and publish
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
      run: |
        ./gradlew clean test build publishAllPublicationsToMavenLocalRepository --no-daemon
        
    - name: Create release bundle
      run: |
        VERSION=${{ steps.extract_version.outputs.VERSION }}
        MAVEN_DIR=~/.m2/repository/io/github/simplesqlgen/simple-sql-generator/$VERSION
        
        echo "üîç Looking for Maven directory: $MAVEN_DIR"
        
        # Check if directory exists
        if [ ! -d "$MAVEN_DIR" ]; then
          echo "‚ùå Maven directory not found: $MAVEN_DIR"
          echo "üîç Searching for simple-sql-generator directories:"
          find ~/.m2 -name "*simple-sql-generator*" -type d 2>/dev/null | head -10
          echo "üîç Contents of ~/.m2/repository:"
          find ~/.m2/repository -maxdepth 3 -type d 2>/dev/null | head -20
          exit 1
        fi
        
        cd "$MAVEN_DIR"
        echo "üìÅ Working in: $(pwd)"
        echo "üìÑ Files found:"
        ls -la
        
        # Generate checksums for existing files
        for file in *.jar *.pom *.module; do
          if [ -f "$file" ]; then
            echo "üîê Generating checksums for $file"
            md5sum "$file" | cut -d' ' -f1 > "$file.md5"
            sha1sum "$file" | cut -d' ' -f1 > "$file.sha1"
          fi
        done
        
        echo "üì¶ Files before bundling:"
        ls -la
        
        # Create directory structure
        mkdir -p io/github/simplesqlgen/simple-sql-generator/$VERSION
        
        # Copy all files (including signatures)
        for ext in jar pom asc module md5 sha1; do
          if ls *.$ext >/dev/null 2>&1; then
            echo "üìã Copying *.$ext files"
            cp *.$ext io/github/simplesqlgen/simple-sql-generator/$VERSION/
          else
            echo "‚ö†Ô∏è No .$ext files found"
          fi
        done
        
        echo "üì¶ Bundle directory contents:"
        find io/ -type f | sort
        
        # Create ZIP bundle
        zip -r simple-sql-generator-$VERSION-bundle.zip io/
        echo "‚úÖ Created bundle: simple-sql-generator-$VERSION-bundle.zip"
        ls -la *.zip
        
        # Verify ZIP contents
        echo "üìã ZIP contents:"
        unzip -l simple-sql-generator-$VERSION-bundle.zip
        
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ~/.m2/repository/io/github/simplesqlgen/simple-sql-generator/${{ steps.extract_version.outputs.VERSION }}/simple-sql-generator-${{ steps.extract_version.outputs.VERSION }}-bundle.zip
        body: |
          ## üöÄ Release ${{ steps.extract_version.outputs.VERSION }}
          
          ### Maven Dependency
          ```gradle
          dependencies {
              implementation 'io.github.simplesqlgen:simple-sql-generator:${{ steps.extract_version.outputs.VERSION }}'
          }
          ```
          
          ### Manual Upload to Maven Central
          1. Download the ZIP bundle from this release
          2. Go to https://central.sonatype.com
          3. Upload the ZIP file
          4. Click Publish
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        